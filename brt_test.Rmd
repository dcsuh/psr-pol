---
title: "BRT Test"
author: "Daniel Suh"
date: "`r Sys.Date()`"
output: html_document
---

# Important note

Functions from brt.functions.R require data to be in "data.frame" format. Make sure to reclass any data using as.data.frame() before running gbm.step



```{r packages}
library(tidyverse)
library(magrittr)
library(here)

source(here("previous work", "elith_tutorial", "brt.functions.R"))
```


```{r read}
gmpd <- read_csv(here("data/GMPD_main.csv"))
panth <- read_tsv(here("data/pantheria/ECOL_90_184/PanTHERIA_1-0_WR05_Aug2008.txt"))
```


```{r psr}
gmpd_PSR <- gmpd %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())
panth %<>% mutate(HostCorrectedName = MSW05_Binomial)
gmpd_panth <- gmpd_PSR %>% inner_join(panth, by="HostCorrectedName")
```


```{r NAs}
gmpd_panth[gmpd_panth == -999.00] <- NA
gmpd_panth$MSW05_Order <- as.factor(gmpd_panth$MSW05_Order)
gmpd_panth$MSW05_Family <- as.factor(gmpd_panth$MSW05_Family)
gmpd_panth$MSW05_Genus <- as.factor(gmpd_panth$MSW05_Genus)

gmpd_panth %<>% dplyr::select(!(`13-3_WeaningHeadBodyLen_mm`))
```


```{r partition data}
set.seed(07981)
train <- sample(1:nrow(gmpd_panth), nrow(gmpd_panth) / 2)
test <- gmpd_panth %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)
gmpd_panth_train <- gmpd_panth[train,]
gmpd_panth_test <- gmpd_panth[test,]
```

```{r}
gmpd_panth_train <- as.data.frame(gmpd_panth_train)
gmpd_panth_test <- as.data.frame(gmpd_panth_test)
```


```{r initial model}
brt1 <- gbm.step(data = gmpd_panth_train, gbm.x = 8:56, gbm.y= 2,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.01, bag.fraction = 0.5)
```


# Try with EltonTraits instead of Pantheria


```{r}
elton <- read_tsv(here("data", "eltontraits", "MamFuncDat.txt"))
```

```{r}
elton %<>% mutate(HostCorrectedName = Scientific)

gmpd_elton <- as.data.frame(gmpd_PSR %>% inner_join(elton, by = "HostCorrectedName"))

gmpd_elton %<>% dplyr::select(!c("ForStrat-Comment", "Diet-Source", "Diet-Certainty","ForStrat-Certainty",
                                 "Activity-Source", "Activity-Certainty", "BodyMass-Source"))

gmpd_elton$`ForStrat-Value` <- as.factor(gmpd_elton$`ForStrat-Value`)
```



```{r}
elton_brt_5_0.001 <- gbm.step(data = gmpd_elton, gbm.x = 6:21, gbm.y= 2,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.001, bag.fraction = 0.5)
```




