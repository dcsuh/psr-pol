---
title: "GMPD Pantheria"
author: "Daniel Suh"
date: "`r Sys.Date()`"
output: html_document
---

# Important note

Make sure to reclass any data using as.data.frame() before running gbm.step



```{r packages, message = F}
library(tidyverse)
library(magrittr)
library(here)
library(janitor)

library(dismo)
library(caret)
library(gbm)
library(VennDiagram)

source(here("previous work", "elith_tutorial", "brt.functions.R"))
```

Read in data. To start, we are focusing on gmpd and pantheria

```{r read}
gmpd <- read_csv(here("data/GMPD_main.csv"))
gmpd_traits <- read_csv(here("data", "GMPD", "GMPD_parasite_traits.csv"))
#panth <- read_csv(here("data/panth_subset.csv"))
refs <- read_csv(here("data/google_refs.csv"))

combine <- read_csv(here("data/combine/COMBINE_archives/trait_data_imputed.csv"))
```




```{r make taxa dummy variables}
dummy_gmpd <- dummyVars(~ HostOrder, data = gmpd)
gmpd_updated <- as_tibble(predict(dummy_gmpd, newdata = gmpd))
gmpd <- cbind(gmpd, gmpd_updated)
gmpd_dummy_vars <- gmpd %>% dplyr::select(HostCorrectedName, HostOrderArtiodactyla, HostOrderCarnivora, HostOrderPerissodactyla, HostOrderPrimates) %>% distinct()

refs %<>% mutate(HostCorrectedName = str_replace(string = species, pattern = "\\+", replacement = " "),
                 ref_count = results) %>% dplyr::select(-c(species, results))
gmpd_dummy_vars %<>% left_join(.,refs, by = "HostCorrectedName")
```


Measure PSR from gmpd

```{r gmpd psr}
gmpd_PSR <- gmpd %>% 
  filter(ParType %in% c("Arthropod", "Helminth", "Virus", "Bacteria", "Protozoa")) %>% #no fungus or prion
  dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())
gmpd_PSR %<>% inner_join(., gmpd_dummy_vars)
#panth %<>% mutate(HostCorrectedName = MSW_Binomial)

```


```{r}
select_out <- function(df) {
  dplyr::select(df, -c(HostCorrectedName, order:phylacine_binomial, adult_forearm_length_mm, biogeographical_realm, terrestrial_volant, 'terrestrial_non-volant'))
}
```


```{r gmpd psr}
combine %<>% mutate(HostCorrectedName = iucn2020_binomial)
gmpd_panth <- gmpd_PSR %>% inner_join(combine, by="HostCorrectedName")
gmpd_panth %<>% select_out()

gmpd_panth %<>% mutate(foraging_stratum = as.factor(foraging_stratum))
gmpd_panth %<>% mutate(island_endemicity = as.factor(island_endemicity))
# gmpd_panth %<>% mutate(biogeographical_realm = as.factor(biogeographical_realm))
```



# Add column for transmission mode
```{r}
gmpd_mode <- gmpd_traits %>% mutate(mode = 
                           ifelse(close == TRUE | nonclose == TRUE,
                                  "direct",
                                  "indirect")) %>%
  filter(!is.na(mode)) #remove parasites without mode data

gmpd_mode %<>% dplyr::select(ParasiteCorrectedName, mode)

gmpd %<>% left_join(., gmpd_mode)
```

# Add column for host specificity
```{r}
load(file=here("data", "GMPD", "get_nri.Rda"))
nri %<>% rownames_to_column(., var = "para")

nri %<>% 
  filter(!is.na(mpd.obs.z)) %>%
  mutate(spec_bin = ifelse(
    mpd.obs.z<median(mpd.obs.z), #class determined above or below median
    "specialist",
    "generalist"
  ))

tabyl(nri$spec_bin)

nri %<>% mutate(ParasiteCorrectedName = para) %>% dplyr::select(ParasiteCorrectedName, spec_bin)

gmpd %<>% left_join(., nri)
```


# Add column for prevalence
```{r}
gmpd_prev <- gmpd %>% 
  dplyr::select(ParasiteCorrectedName, Prevalence) %>%
  filter(!is.na(Prevalence)) %>%
  group_by(ParasiteCorrectedName) %>%
  summarize(Prevalence=mean(Prevalence)) %>% #get average prevalence
  mutate(prev_bin = ifelse(
    Prevalence > median(Prevalence), #above or below median
    "high_prevalence",
    "low_prevalence"
  ))

tabyl(gmpd_prev$prev_bin)

gmpd_prev %<>% dplyr::select(ParasiteCorrectedName, prev_bin)

gmpd %<>% left_join(., gmpd_prev)
```



# Add column for intensity
```{r}
gmpd_int <- gmpd %>%
  dplyr::select(ParasiteCorrectedName, Intensity) %>%
  mutate(Intensity = as.numeric(Intensity)) %>% #some intensity measures included characters to indicate exponent or range. these are removed for now
  filter(!is.na(Intensity)) %>%
  filter(Intensity>0) %>% #some intensity measures were 0. these were removed
  group_by(ParasiteCorrectedName) %>%
  summarize(Intensity = mean(Intensity)) %>% #get average intensity
  mutate(int_bin = ifelse(
    Intensity > median(Intensity), #above or below median
    "high_intensity",
    "low_intensity"
  ))

tabyl(gmpd_int$int_bin)

gmpd_int %<>% dplyr::select(ParasiteCorrectedName, int_bin)

gmpd %<>% left_join(., gmpd_int)
```






Prepare data by partitioning

```{r partition data}
set.seed(07981)
train <- sample(1:nrow(gmpd_panth), nrow(gmpd_panth)*0.8)
test <- gmpd_panth %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)
gmpd_panth_train <- gmpd_panth[train,]
gmpd_panth_test <- gmpd_panth[test,]
```

```{r gmpd train test datasets}
gmpd_panth_train <- as.data.frame(gmpd_panth_train)
gmpd_panth_test <- as.data.frame(gmpd_panth_test)
```


```{r gmpd initial model, warning = F, eval=F}

brt1_elith_full <- gbm.step(data = gmpd_panth_train, gbm.x = 2:ncol(gmpd_panth_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.004, bag.fraction = 0.5)

summary(brt1_elith_full)
```


#parasite type

```{r macro}
gmpd_macro <- gmpd %>% filter(ParType %in% c("Helminth", "Arthropod")) %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_macro %<>% inner_join(., gmpd_dummy_vars)
```

```{r micro}
gmpd_micro <- gmpd %>% filter(ParType %in% c("Protozoa", "Virus", "Bacteria")) %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_micro %<>% inner_join(., gmpd_dummy_vars)
```

#transmission mode

```{r}
gmpd_direct <- gmpd %>% filter(mode == "direct") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_direct %<>% inner_join(., gmpd_dummy_vars)
```

```{r}
gmpd_indirect <- gmpd %>% filter(mode == "indirect") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_indirect %<>% inner_join(., gmpd_dummy_vars)
```

#specialism

```{r}
gmpd_specialist <- gmpd %>% filter(spec_bin == "specialist") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_specialist %<>% inner_join(., gmpd_dummy_vars)
```

```{r}
gmpd_generalist <- gmpd %>% filter(spec_bin == "generalist") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_generalist %<>% inner_join(., gmpd_dummy_vars)
```


#prevalence

```{r}
gmpd_low_prev <- gmpd %>% filter(prev_bin == "low_prevalence") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_low_prev %<>% inner_join(., gmpd_dummy_vars)
```

```{r}
gmpd_high_prev <- gmpd %>% filter(prev_bin == "high_prevalence") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_high_prev %<>% inner_join(., gmpd_dummy_vars)
```


#intensity

```{r}
gmpd_low_int <- gmpd %>% filter(int_bin == "high_intensity") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_low_int %<>% inner_join(., gmpd_dummy_vars)
```

```{r}
gmpd_high_int <- gmpd %>% filter(int_bin == "low_intensity") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_high_int %<>% inner_join(., gmpd_dummy_vars)
```





```{r}
join_name <- function(df){
  as.data.frame(df %>% inner_join(combine, by="HostCorrectedName"))
}
```


```{r join name}
gmpd_panth_macro <- join_name(gmpd_macro)
gmpd_panth_micro <- join_name(gmpd_micro)

gmpd_panth_direct <- join_name(gmpd_direct)
gmpd_panth_indirect <- join_name(gmpd_indirect)

gmpd_panth_specialist <- join_name(gmpd_specialist)
gmpd_panth_generalist <- join_name(gmpd_generalist)

gmpd_panth_high_prev <- join_name(gmpd_high_prev)
gmpd_panth_low_prev <- join_name(gmpd_low_prev)

gmpd_panth_high_int <- join_name(gmpd_high_int)
gmpd_panth_low_int <- join_name(gmpd_low_int)
```

Use only hosts that overlap
```{r}
hosts_overlap <- function(df_a, df_b){
  hosts_a <- df_a$HostCorrectedName
  hosts_b <- df_b$HostCorrectedName
  
  Reduce(intersect, list(hosts_a, hosts_b))
}
```

```{r}
partype_intersect <- hosts_overlap(gmpd_panth_macro, gmpd_panth_micro)
mode_intersect <- hosts_overlap(gmpd_panth_direct, gmpd_panth_indirect)
spec_intersect <- hosts_overlap(gmpd_panth_specialist, gmpd_panth_generalist)
prev_intersect <- hosts_overlap(gmpd_panth_low_prev, gmpd_panth_high_prev)
int_intersect <- hosts_overlap(gmpd_panth_low_int, gmpd_panth_high_int)
```

```{r}
gmpd_panth_macro %<>% filter(HostCorrectedName %in% partype_intersect)
gmpd_panth_micro %<>% filter(HostCorrectedName %in% partype_intersect)

gmpd_panth_direct %<>% filter(HostCorrectedName %in% mode_intersect)
gmpd_panth_indirect %<>% filter(HostCorrectedName %in% mode_intersect)

gmpd_panth_specialist %<>% filter(HostCorrectedName %in% spec_intersect)
gmpd_panth_generalist %<>% filter(HostCorrectedName %in% spec_intersect)

gmpd_panth_low_prev %<>% filter(HostCorrectedName %in% prev_intersect)
gmpd_panth_high_prev %<>% filter(HostCorrectedName %in% prev_intersect)

gmpd_panth_low_int %<>% filter(HostCorrectedName %in% int_intersect)
gmpd_panth_high_int %<>% filter(HostCorrectedName %in% int_intersect)
```


```{r}
prep_data <- function(df_a){
  df_a %<>% select_out()

  df_a %<>% mutate(foraging_stratum = as.factor(foraging_stratum))
  df_a %<>% mutate(island_endemicity = as.factor(island_endemicity))
  # df_a %<>% mutate(biogeographical_realm = as.factor(biogeographical_realm))
  df_a
}
```


```{r}
gmpd_panth_macro %<>% prep_data()
gmpd_panth_micro %<>% prep_data()

gmpd_panth_direct %<>% prep_data()
gmpd_panth_indirect %<>% prep_data()

gmpd_panth_specialist %<>% prep_data()
gmpd_panth_generalist %<>% prep_data()

gmpd_panth_high_prev %<>% prep_data()
gmpd_panth_low_prev %<>% prep_data()

gmpd_panth_high_int %<>% prep_data()
gmpd_panth_low_int %<>% prep_data()
```



```{r}
train_test <- function(df_a){
  train <- sample(1:nrow(df_a), nrow(df_a) * 0.8)
  test <- df_a %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
  test <- as.integer(test$row_num)
  

  df_train <- df_a[train,]
  df_test <- df_a[test,]
  
  list(train, test)
}
```


```{r}

type_train <- train_test(gmpd_panth_macro)
macro_train <- gmpd_panth_macro[type_train[[1]],]
macro_test <- gmpd_panth_macro[type_train[[2]],]
micro_train <- gmpd_panth_micro[type_train[[1]],]
micro_test <- gmpd_panth_micro[type_train[[2]],]

mode_train <- train_test(gmpd_panth_direct)
direct_train <- gmpd_panth_direct[mode_train[[1]],]
direct_test <- gmpd_panth_direct[mode_train[[2]],]
indirect_train <- gmpd_panth_indirect[mode_train[[1]],]
indirect_test <- gmpd_panth_indirect[mode_train[[2]],]

spec_train <- train_test(gmpd_panth_specialist)
specialist_train <- gmpd_panth_specialist[spec_train[[1]],]
specialist_test <- gmpd_panth_specialist[spec_train[[2]],]
generalist_train <- gmpd_panth_generalist[spec_train[[1]],]
generalist_test <- gmpd_panth_generalist[spec_train[[2]],]

prev_train <- train_test(gmpd_panth_high_prev)
high_prev_train <- gmpd_panth_high_prev[prev_train[[1]],]
high_prev_test <- gmpd_panth_high_prev[prev_train[[2]],]
low_prev_train <- gmpd_panth_low_prev[prev_train[[1]],]
low_prev_test <- gmpd_panth_low_prev[prev_train[[2]],]

int_train <- train_test(gmpd_panth_high_int)
high_int_train <- gmpd_panth_high_int[int_train[[1]],]
high_int_test <- gmpd_panth_high_int[int_train[[2]],]
low_int_train <- gmpd_panth_low_int[int_train[[1]],]
low_int_test <- gmpd_panth_low_int[int_train[[2]],]
```




Elith method


```{r}
brt_macro <- gbm.step(data = macro_train, gbm.x = 2:ncol(macro_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.004, bag.fraction = 0.5)
```

```{r}
brt_micro <- gbm.step(data = micro_train, gbm.x = 2:ncol(micro_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.003, bag.fraction = 0.5)
```

```{r}
brt_direct <- gbm.step(data = direct_train, gbm.x = 2:ncol(direct_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.003, bag.fraction = 0.5)
```

```{r}
brt_indirect <- gbm.step(data = indirect_train, gbm.x = 2:ncol(indirect_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.003, bag.fraction = 0.5)
```

```{r}
brt_specialist <- gbm.step(data = specialist_train, gbm.x = 2:ncol(specialist_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.003, bag.fraction = 0.5)
```

```{r}
brt_generalist <-gbm.step(data = generalist_train, gbm.x = 2:ncol(generalist_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.003, bag.fraction = 0.5)
```

```{r}
brt_high_prev <- gbm.step(data = high_prev_train, gbm.x = 2:ncol(high_prev_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.003, bag.fraction = 0.5)
```

```{r}
brt_low_prev <- gbm.step(data = low_prev_train, gbm.x = 2:ncol(low_prev_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.003, bag.fraction = 0.5)
```

```{r}
brt_high_int <- gbm.step(data = high_int_train, gbm.x = 2:ncol(high_int_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.004, bag.fraction = 0.5)
```

```{r}
brt_low_int <- gbm.step(data = low_int_train, gbm.x = 2:ncol(low_int_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.004, bag.fraction = 0.5)
```


```{r}
summary(brt_macro)
summary(brt_micro)
```

```{r}
summary(brt_direct)
summary(brt_indirect)
```

```{r}
summary(brt_specialist)
summary(brt_generalist)
```

```{r}
summary(brt_high_prev)
summary(brt_low_prev)
```

```{r}
summary(brt_high_int)
summary(brt_low_int)
```





```{r}
gbm.plot(brt_macro, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "macroparasites")
gbm.plot(brt_micro, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "microparasites")
```

```{r}
gbm.plot(brt_direct, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "direct")
gbm.plot(brt_indirect, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "indirect")
```

```{r}
gbm.plot(brt_specialist, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "generalist")
gbm.plot(brt_generalist, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "specialist")
```

```{r}
gbm.plot(brt_high_prev, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "high_prevalence")
gbm.plot(brt_low_prev, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "low_prevalence")
```

```{r}
gbm.plot(brt_high_int, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "high_intensity")
gbm.plot(brt_low_int, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "low_intensity")
```



Function for mean squared error and root mean square deviation
```{r}
get_mse <- function(model, test) {
  pred <- gbm.predict.grids(model, test, want.grids=F, sp.name = "preds")
  MSE <- mean((pred - test$psr)^2)
  RMSD <- sqrt(mean((pred-test$psr)^2))
  name <- print(substitute(model))
  print(paste("Mean Squared Error for", name,"= ", MSE))
  print(paste("Root Mean Square Deviation for", name, " = ", RMSD))
}
```


```{r}
get_mse(brt_macro, macro_test)
get_mse(brt_micro, micro_test)
```
```{r}
gbm.plot.fits(brt_macro)

macro_predict <- gbm.predict.grids(brt_macro, macro_test, want.grids=F, sp.name="preds")
```

```{r}
macro_test$psr
macro_predict
dat <- as.data.frame(cbind(macro_predict, macro_test$psr))
ggplot(dat, aes(x=V2, y=macro_predict)) + geom_point()
```



```{r}
get_mse(brt_direct, direct_test)
get_mse(brt_indirect, indirect_test)
```


```{r}
get_mse(brt_specialist, specialist_test)
get_mse(brt_generalist, generalist_test)
```


```{r}
get_mse(brt_high_prev, high_prev_test)
get_mse(brt_low_prev, low_prev_test)
```


```{r}
get_mse(brt_high_int, high_int_test)
get_mse(brt_low_int, low_int_test)
```
