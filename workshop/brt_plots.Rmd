---
title: "BRT plots"
output: html_document
date: "2023-07-14"
---

```{r packages}
library(here)
library(tidyverse)
library(magrittr)

library(dismo)
library(gbm)
library(pdp)
library(cowplot)
```

```{r data}
var_type <- read_csv(here("data/var_type.csv"))

brt1_elith_full <- readRDS(here("processed_data/brt_results/full_elith.rds"))
brt2_elith_helm <- readRDS(here("processed_data/brt_results/helm_elith.rds"))
brt3_elith_virus <- readRDS(here("processed_data/brt_results/virus_elith.rds"))
brt4_elith_arth <- readRDS(here("processed_data/brt_results/arth_elith.rds"))
brt5_elith_bact <- readRDS(here("processed_data/brt_results/bact_elith.rds"))
brt6_elith_proto <- readRDS(here("processed_data/brt_results/proto_elith.rds"))
brt7_elith_macro <- readRDS(here("processed_data/brt_results/macro_elith.rds"))
brt8_elith_micro <- readRDS(here("processed_data/brt_results/micro_elith.rds"))


summary(brt1_elith_full)
summary(brt2_elith_helm)
summary(brt3_elith_virus)
summary(brt4_elith_arth)
summary(brt5_elith_bact)
summary(brt6_elith_proto)
summary(brt7_elith_macro)
summary(brt8_elith_micro)

```

```{r gmpd pdp 6}
gbm.plot(brt1_elith_full, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "full")
gbm.plot(brt2_elith_helm, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "helminth")
gbm.plot(brt3_elith_virus, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "virus")
gbm.plot(brt4_elith_arth, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "arthropod")
gbm.plot(brt5_elith_bact, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "bacteria")
gbm.plot(brt6_elith_proto, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "protozoa")
gbm.plot(brt7_elith_macro, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "macroparasites")
gbm.plot(brt8_elith_micro, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "microparasites")
```

```{r plot gbm test}
plot.gbm(brt1_elith_full, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "full")

```

```{r plot longevity}
brt1_names <- brt1_elith_full$var.names
brt2_names <- brt2_elith_helm$var.names
brt3_names <- brt3_elith_virus$var.names
brt4_names <- brt4_elith_arth$var.names
brt5_names <- brt5_elith_bact$var.names
brt6_names <- brt6_elith_proto$var.names
brt7_names <- brt7_elith_macro$var.names
brt8_names <- brt8_elith_micro$var.names


brt1_long_plot_no <- which(brt1_names %in% c("MaxLongevity_m"))
brt2_long_plot_no <- which(brt2_names %in% c("MaxLongevity_m"))
brt3_long_plot_no <- which(brt3_names %in% c("MaxLongevity_m"))
brt4_long_plot_no <- which(brt4_names %in% c("MaxLongevity_m"))
brt5_long_plot_no <- which(brt5_names %in% c("MaxLongevity_m"))
brt6_long_plot_no <- which(brt6_names %in% c("MaxLongevity_m"))
brt7_long_plot_no <- which(brt7_names %in% c("MaxLongevity_m"))
brt8_long_plot_no <- which(brt8_names %in% c("MaxLongevity_m"))


gbm.plot(brt1_elith_full, variable.no = brt1_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "full")
gbm.plot(brt2_elith_helm, variable.no = brt2_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "helm")
gbm.plot(brt3_elith_virus, variable.no = brt3_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "virus")
gbm.plot(brt4_elith_arth, variable.no = brt4_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "arth")
gbm.plot(brt5_elith_bact, variable.no = brt5_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "bact")
gbm.plot(brt6_elith_proto, variable.no = brt6_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "proto")
gbm.plot(brt7_elith_macro, variable.no = brt7_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "macro")
gbm.plot(brt8_elith_micro, variable.no = brt8_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "micro")

```

```{r plot gbm longevity}
plot.gbm(brt1_elith_full, n.plots=6, i.var = brt1_long_plot_no, main = "full", type = "response")
plot.gbm(brt2_elith_helm, n.plots=6, i.var = brt2_long_plot_no, main = "helminth", type = "response")
plot.gbm(brt3_elith_virus, n.plots=6, i.var = brt3_long_plot_no, main = "virus", type = "response")
plot.gbm(brt4_elith_arth, n.plots=6, i.var = brt4_long_plot_no, main = "arthropod", type = "response")
plot.gbm(brt5_elith_bact, n.plots=6, i.var = brt5_long_plot_no, main = "bacteria", type = "response")
plot.gbm(brt6_elith_proto, n.plots=6, i.var = brt6_long_plot_no, main = "protozoa", type = "response")
plot.gbm(brt7_elith_macro, n.plots=6, i.var = brt7_long_plot_no, main = "macroparasites", type = "response")
plot.gbm(brt8_elith_micro, n.plots=6, i.var = brt8_long_plot_no, main = "microparasites", type = "response")
```


```{r relative importance}
brt1_full_ri <- brt1_elith_full$contributions
brt2_helm_ri <- brt2_elith_helm$contributions
brt3_virus_ri <- brt3_elith_virus$contributions
brt4_arth_ri <- brt4_elith_arth$contributions
brt5_bact_ri <- brt5_elith_bact$contributions
brt6_proto_ri <- brt6_elith_proto$contributions
brt7_macro_ri <- brt7_elith_macro$contributions
brt8_micro_ri <- brt8_elith_micro$contributions

```

```{r bind rows}
brt1_full_ri %<>% mutate(par_type = "full")
brt2_helm_ri %<>% mutate(par_type = "helminth")
brt3_virus_ri %<>% mutate(par_type = "virus")
brt4_arth_ri %<>% mutate(par_type = "arthropod")
brt5_bact_ri %<>% mutate(par_type = "bacteria")
brt6_proto_ri %<>% mutate(par_type = "protozoa")
brt7_macro_ri %<>% mutate(par_type = "macro")
brt8_micro_ri %<>% mutate(par_type = "micro")



brt_ri <- bind_rows(brt1_full_ri, brt2_helm_ri, brt3_virus_ri, brt4_arth_ri, brt5_bact_ri, brt6_proto_ri, brt7_macro_ri, brt8_micro_ri)
rownames(brt_ri) <- NULL
```


```{r make rel inf df}
brt_ri %<>% group_by(par_type) %>%
  arrange(desc(rel.inf)) %>%
  mutate(ranking = row_number())

var_type %<>% mutate(var = variable) %>% dplyr::select(-c(variable))

brt_ri %<>% left_join(., var_type)
```


```{r plot by variable}
brt_ri %>% filter(par_type != "full") %>%
ggplot(data = ., aes(x = par_type, y = ranking, group = var)) +
  geom_line(aes(color = var)) +
  geom_point(aes(color = var, alpha = 1), size = 4) +
  scale_y_reverse(breaks = 1:nrow(brt_ri))
```


```{r plot by type}
brt_ri %>% filter(par_type != "full") %>%
ggplot(data = ., aes(x = par_type, y = ranking, group = var)) +
  geom_line(aes(color = var_type)) +
  geom_point(aes(color = var_type), size = 4) +
  scale_y_reverse(breaks = 1:nrow(brt_ri)) + 
  theme_minimal()
```

```{r plot by macro micro}
brt_ri %>% filter(par_type %in% c("macro", "micro")) %>%
ggplot(data = ., aes(x = par_type, y = ranking, group = var, size = rel.inf)) +
  geom_line(aes(color = var), size = 1) +
#  scale_shape_manual(values=1:nlevels(as.factor(brt_ri$var_type))) +
#  scale_color_discrete(type = getOption("ggplot2.discrete.colour")) + 
  geom_point(aes(color = var)) +
  scale_y_reverse(breaks = 1:nrow(brt_ri)) + 
  theme_minimal()
```



```{r pdp}
brt1_train_data <- brt1_elith_full$gbm.call$dataframe
brt2_train_data <- brt2_elith_helm$gbm.call$dataframe

make_plots <- function(model, var, bin_n = 10) {
  
  data <- model$gbm.call$dataframe
  
  var_no <- which(colnames(data) %in% c(var))
  
  inv <- pdp::partial(model, n.trees=model$n.trees, var, prob = T, train = data)
  
  x_max <- max(data[var_no], na.rm=T)
  
  plot1 <- inv %>%
  na.omit() %>%
  ggplot() +
    geom_line(aes(x = .data[[var]], y = yhat),color="black",size=1) +
    xlim(0,x_max)+
    ylab(" ") +
    theme_minimal() +
    theme(axis.title.x = element_blank())+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    theme(axis.text.x=element_blank(),
    axis.ticks.x=element_blank(),axis.text=element_text(size=12))
  
  plot2 <- data %>%
  na.omit() %>%
  ggplot(aes(.data[[var]])) +
    geom_histogram(breaks = seq(0,x_max, x_max/bin_n), fill="gray") +
    #geom_histogram(fill="gray",binwidth=20) +
    scale_y_continuous(position = "right")+
    ylab("") +
    theme_minimal() +
    theme(axis.title.x = element_blank(),axis.text=element_text(size=12))#+
    #theme(plot.margin=unit(c(0,0,0,1.25),"cm"))
  
  lin <- add_sub(plot1," ")
  his <- add_sub(plot2,var,size=12)
  p.max_long<-ggdraw()
  p.max_long
}

tmp <- make_plots(brt1_elith_full, "MaxLongevity_m")

tmp + 
  draw_plot(his, x=0.03, scale = 1) +
  draw_plot(lin, x=0.05, scale = 1, y = 0.05)
```


```{r overlay}
lin <- add_sub(plot1," ")
his <- add_sub(plot2,"Max Longevity",size=12)
p.max_long<-ggdraw() +
  draw_plot(his,x=0.03,scale=1) +
  draw_plot(lin,x=0,scale=1, y = 0.05)

p.max_long
```


