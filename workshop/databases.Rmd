---
title: "databases"
author: "Daniel Suh"
date: "`r Sys.Date()`"
output: html_document
---

Overview of each database


```{r packages, message = F}
library(here)
library(tidyverse)
library(magrittr)
```

```{r functions}
makeMissing <- function(df) {
  tibble(col = names(colSums(is.na(df))), missing = as.numeric(colSums(is.na(df))))
}

plotMissing <- function(df) {
  df %>% arrange(missing) %>% 
  mutate(col=factor(col, levels=col)) %>% 
  ggplot(.,aes(x=col,y=missing)) + 
    geom_col() + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
    labs(title = deparse(substitute(df)))
}
```

```{r setTheme}
theme_set(theme_bw())
```


# Amniote

```{r readAmniote}
amniote <- read_csv(here("data", "amniote", "ECOL_96_269/Data_Files/Amniote_Database_Aug_2015.csv")) #average value from amniote2's ranges
#amniote1 <- read_csv(here("data", "amniote", "ECOL_96_269/Data_Files/Amniote_Range_Count_Aug_2015.csv")) #ranges taken from amniote2's sources
#amniote2 <- read_csv(here("data", "amniote", "ECOL_96_269/Data_Files/Amniote_Sparse_Table_Aug_2015.csv")) #all sources and observations
```

```{r exploreAmniote}
amn_mamm <- amniote %>% filter(class == "Mammalia")
amn_mamm[amn_mamm==-999] <- NA

amn_missing <- makeMissing(amn_mamm)

plotMissing(amn_missing)
```

```{r}
amniote_cols <- tibble(df = "amniote",
                       variable = colnames(amniote))
```



# AnimalTraits

```{r readAnimalTraits}
animal <- read_csv(here("data", "animaltraits", "observations.csv"))
```

```{r exploreAnimalTraits}
ani_mamm <- animal %>% filter(class == "Mammalia")

ani_missing <- makeMissing(ani_mamm)

plotMissing(ani_missing)
```

```{r}
animal_cols <- tibble(df = "animal",
                      variable = colnames(animal))
```



# EltonTraits

```{r readElton}
elton <- read_tsv(here("data", "eltontraits", "MamFuncDat.txt"))
```

```{r exploreElton}
elton_missing <- makeMissing(elton)

plotMissing(elton_missing)
```


```{r}
elton_cols <- tibble(df = "elton",
                     variable = colnames(elton))
```




# HormoneBase

```{r readHormone}
hormone <- read_csv(here("data", "hormonebase", "HormoneBase_v1.csv"))
```

```{r exploreHormone}
horm_mamm <- hormone %>% filter(Vert_Group == "Mammal")

horm_missing <- makeMissing(horm_mamm)

plotMissing(horm_missing)
```

```{r}
hormone_cols <- tibble(df = "hormone",
                       variable = colnames(hormone))
```



# Pantheria

```{r}
panth1 <- read_tsv(here("data", "pantheria", "ECOL_90_184/PanTHERIA_1-0_WR05_Aug2008.txt"))
#panth2 <- read_tsv(here("data", "pantheria", "ECOL_90_184/PanTHERIA_1-0_WR93_Aug2008.txt"))
```

There are two pantheria files that are slightly different. I assume WR05 stands for 2005 and is the most up-to-date version so I will use that.

# ```{r}
# panth1_names <- panth1$MSW05_Binomial
# panth2_names <- panth2$MSW93_Binomial
# 
# panth2_subset <- panth2[which(panth2_names %in% panth1_names),]
# panth2_out <- panth2[which(!(panth2_names %in% panth1_names)),]
# ```

```{r}
panth1 %<>% rename_with(~ gsub("MSW05_","", .x, fixed = T))
#panth2 %<>% rename_with(~ gsub("MSW93_","", .x, fixed = T))

#panth1 %<>% rename_with(~ gsub("14-1_InterbirthInterval_d", "14-1_InterBirthInterval_d", .x, fixed = T))

#panth1 %<>% rename_with(~ gsub("26-4_GR_MidRangeLat_dd", "26-4_GR_MRLat_dd", .x, fixed = T))

#panth1 %<>% rename_with(~ gsub("26-7_GR_MidRangeLong_dd", "26-7_GR_MRLong_dd", .x, fixed = T))

#panth <- rbind(panth1, panth2)

```

```{r}
panth1[panth1 == -999.0] <- NA
```



```{r}
panth_missing <- makeMissing(panth1)

plotMissing(panth_missing)
```

```{r}
panth_cols <- tibble(df = "panth",
                     variable = colnames(panth1))
```



Life history data variables compiled

```{r}
all_cols <- rbind(amniote_cols, animal_cols, elton_cols, hormone_cols, panth_cols)

write_csv(all_cols, here("processed_data", "traitnames.csv"))
```









# Host Parasite Association Data

# Clover

```{r, message = F}
mammals <- read_csv(here("data/clover/CLOVER_0.1_MammalViruses_AssociationsFlatFile.csv"))
viruses <- read_csv(here("data/clover/CLOVER_1.0_Viruses_AssociationsFlatFile.csv"))
helminths <- read_csv(here("data/clover/CLOVER_1.0_HelminthProtozoaFungi_AssociationsFlatFile.csv"))
bacteria <- read_csv(here("data/clover/CLOVER_1.0_Bacteria_AssociationsFlatFile.csv"))
```


```{r}
colnames(mammals) <- gsub("Virus", "Pathogen", colnames(mammals))
mammals %<>% mutate(PathogenType = "virus")
```


```{r, message = F}
clover <- rbind(mammals,viruses,bacteria,helminths)
```

```{r}
clover_missing <- makeMissing(clover)

plotMissing(clover_missing)
```

# GMPD

```{r}
gmpd <- read_csv(here("data/GMPD_main.csv"))
```

```{r}
gmpd_missing <- makeMissing(gmpd)

plotMissing(gmpd_missing)
```



# How much data do I add from each database
 - Amniote
 - AnimalTraits
 - EltonTraits
 - HormoneBase
 - Pantheria
 - GMPD

Get host names from each database
```{r}
amn_mamm_names <- tolower(unique(paste(amn_mamm$genus, amn_mamm$species, sep = " ")))
ani_mamm_names <- tolower(unique(ani_mamm$species))
elton_names <- tolower(unique(elton$Scientific))
horm_mamm_names <- tolower(unique(horm_mamm$Species))
panth_names <- tolower(unique(panth1$Binomial))
gmpd_names <- tolower(unique(gmpd$HostCorrectedName))
clover_names <- tolower(unique(mammals$Host))

all_host_names <- unique(c(amn_mamm_names, ani_mamm_names, elton_names, horm_mamm_names, panth_names, gmpd_names, clover_names))

names_mat <-
tibble(all_hosts = all_host_names, 
       amniote = as.numeric(all_host_names %in% amn_mamm_names),
       animal_traits = as.numeric(all_host_names %in% ani_mamm_names),
       elton = as.numeric(all_host_names %in% elton_names),
       horm = as.numeric(all_host_names %in% horm_mamm_names),
       panth = as.numeric(all_host_names %in% panth_names),
       gmpd = as.numeric(all_host_names %in% gmpd_names),
       clover = as.numeric(all_host_names %in% clover_names))

names_mat %<>% mutate(host_yes = rowSums(across(c(amniote:panth))),
                       para_yes = rowSums(across(c(gmpd:clover))))

names_mat_subset <- names_mat %>% filter(para_yes>0)
```

```{r}
names_mat %>% ggplot(.,aes(host_yes)) + geom_histogram()
names_mat_subset %>% ggplot(.,aes(host_yes)) + geom_histogram()
names_mat %>% ggplot(.,aes(para_yes)) + geom_histogram()
```



```{r}
library(VennDiagram)

venn.diagram(x = list(amn_mamm_names, gmpd_names, clover_names),
             category.names = c("amniote", "gmpd", "clover"),
             filename = "amniote_overlap.png",
             output=T)

venn.diagram(x = list(ani_mamm_names, gmpd_names, clover_names),
             category.names = c("animalTraits", "gmpd", "clover"),
             filename = "animalTraits_overlap.png",
             output=T)

venn.diagram(x = list(elton_names, gmpd_names, clover_names),
             category.names = c("Elton", "gmpd", "clover"),
             filename = "elton_overlap.png",
             output=T)

venn.diagram(x = list(horm_mamm_names, gmpd_names, clover_names),
             category.names = c("hormone", "gmpd", "clover"),
             filename = "hormone_overlap.png",
             output=T)

venn.diagram(x = list(panth_names, gmpd_names, clover_names),
             category.names = c("Pantheria", "gmpd", "clover"),
             filename = "panth_overlap.png",
             output=T)

venn.diagram(x = list(amn_mamm_names, elton_names, panth_names),
             category.names = c("amniote", "elton", "pantheria"),
             filename = "hosts_overlap.png",
             output=T)
```

Amniote, Elton, and Panth share 336 hosts with both gmpd and clover and about 660 with clover.



