---
title: "GMPD Pantheria"
author: "Daniel Suh"
date: "`r Sys.Date()`"
output: html_document
---

# Important note

Make sure to reclass any data using as.data.frame() before running gbm.step



```{r packages}
library(tidyverse)
library(magrittr)
library(here)

library(dismo)
library(caret)
library(gbm)

#source(here("previous work", "elith_tutorial", "brt.functions.R"))
```

Read in data. To start, we are focusing on gmpd and pantheria

```{r read}
gmpd <- read_csv(here("data/GMPD_main.csv"))
panth <- read_tsv(here("data/pantheria/ECOL_90_184/PanTHERIA_1-0_WR05_Aug2008.txt"))
var_type <- read_csv(here("data/var_type.csv"))
```

We need to change these maxed out values (-999) to be NAs instead. We are also removing some variables if they are all NA or are not informative for our purposes (taxonomy)

```{r panth NAs}
panth[panth == -999.00] <- NA

colnames(panth) <- gsub("\\d+-\\d+_", "", colnames(panth))
colnames(panth) <- gsub("*\\d+", "", colnames(panth))
colnames(panth) <- gsub("/", "_", colnames(panth))


panth$ref_count <- str_count(panth$References, ";")

panth$`ActivityCycle` <- as.factor(panth$`ActivityCycle`)
panth$`DietBreadth` <- as.factor(panth$`DietBreadth`)
panth$`HabitatBreadth` <- as.factor(panth$`HabitatBreadth`)
panth$`Terrestriality` <- as.factor(panth$`Terrestriality`)
panth$`TrophicLevel` <- as.factor(panth$`TrophicLevel`)

# panth %<>% dplyr::select(!c(`WeaningHeadBodyLen_mm`, `AdultForearmLen_mm`, `AdultBodyMass_g_EXT`, `NeonateBodyMass_g_EXT`, `WeaningBodyMass_g_EXT`, MSW_Species, MSW_Genus, MSW_Family, `WeaningBodyMass_g`)) #too many NAs or just taxon

panth %<>% dplyr::select(!c(MSW_Species, MSW_Genus, MSW_Family))

env_vars <- var_type %>% filter(var_type %in% c("environment", "anthropogenic", "other", "metabolic", "behavior", "morphology"))
env_vars <- env_vars$variable


panth %<>% dplyr::select(!env_vars)
```


```{r categorize variables}


```


```{r make taxa dummy variables}
dummy_gmpd <- dummyVars(~ HostOrder, data = gmpd)
gmpd_updated <- as_tibble(predict(dummy_gmpd, newdata = gmpd))
gmpd <- cbind(gmpd, gmpd_updated)
gmpd_dummy_vars <- gmpd %>% dplyr::select(HostCorrectedName, HostOrderArtiodactyla, HostOrderCarnivora, HostOrderPerissodactyla, HostOrderPrimates) %>% distinct()
```


Measure PSR from gmpd

```{r gmpd psr}
gmpd_PSR <- gmpd %>% filter(ParType %in% c("Helminth", "Virus")) %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())
gmpd_PSR %<>% inner_join(., gmpd_dummy_vars)
panth %<>% mutate(HostCorrectedName = MSW_Binomial)
gmpd_panth <- gmpd_PSR %>% inner_join(panth, by="HostCorrectedName")
gmpd_panth %<>% dplyr::select(-c(HostCorrectedName, MSW_Order, MSW_Binomial))
```

Prepare data by partitioning

```{r partition data}
set.seed(07981)
train <- sample(1:nrow(gmpd_panth), nrow(gmpd_panth)*0.8)
test <- gmpd_panth %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)
gmpd_panth_train <- gmpd_panth[train,]
gmpd_panth_test <- gmpd_panth[test,]
```

```{r gmpd train test datasets}
gmpd_panth_train <- as.data.frame(gmpd_panth_train)
gmpd_panth_test <- as.data.frame(gmpd_panth_test)
```


```{r gmpd initial model, warning = F}

brt1_elith_full <- gbm.step(data = gmpd_panth_train, gbm.x = 2:ncol(gmpd_panth_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.003, bag.fraction = 0.5)
```

```{r}
summary(brt1_elith_full)
```


```{r gmpd parasite type}
gmpd_macro <- gmpd %>% filter(ParType %in% c("Helminth")) %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_macro %<>% inner_join(., gmpd_dummy_vars)

gmpd_micro <- gmpd %>% filter(ParType %in% c("Virus")) %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% 
  distinct() %>% 
  group_by(HostCorrectedName) %>% 
  summarize(psr=n())

gmpd_micro %<>% inner_join(., gmpd_dummy_vars)

gmpd_panth_macro <- as.data.frame(gmpd_macro %>% inner_join(panth, by="HostCorrectedName"))
gmpd_panth_micro <- as.data.frame(gmpd_micro %>% inner_join(panth, by="HostCorrectedName"))


```

Use only hosts that overlap between gmpd_panth_macro and gmpd_panth_micro
```{r}
gmpd_panth_macro_hosts <- gmpd_panth_macro$MSW_Binomial #get all host species from macro database
gmpd_panth_micro %<>% filter(MSW_Binomial %in% gmpd_panth_macro_hosts) #choose host species from macro that are also in micro
gmpd_panth_micro_hosts <- gmpd_panth_micro$MSW_Binomial #get remaining host species from micro database
gmpd_panth_macro %<>% filter(MSW_Binomial %in% gmpd_panth_micro_hosts) #make sure these are also in macro database
sum(!gmpd_panth_macro$MSW_Binomial %in% gmpd_panth_micro$MSW_Binomial) #check.
```



```{r}
gmpd_panth_micro %<>% dplyr::select(-c(HostCorrectedName, MSW_Order, MSW_Binomial))
gmpd_panth_macro %<>% dplyr::select(-c(HostCorrectedName, MSW_Order, MSW_Binomial))

train <- sample(1:nrow(gmpd_panth_macro), nrow(gmpd_panth_macro) * 0.8)
test <- gmpd_panth_macro %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)
gmpd_panth_macro_train <- gmpd_panth_macro[train,]
gmpd_panth_macro_test <- gmpd_panth_macro[test,]
gmpd_panth_micro_train <- gmpd_panth_micro[train,]
gmpd_panth_micro_test <- gmpd_panth_micro[test,]

```


Elith method
```{r macro micro model, warning=F}
# brt2_elith_macro <- gbm.step(data = gmpd_panth_macro_train, gbm.x = 2:47, gbm.y= 1,
#                  family = "poisson", tree.complexity = 5,
#                  learning.rate = 0.001, bag.fraction = 0.5)
# 
# brt3_elith_micro <- gbm.step(data = gmpd_panth_micro_train, gbm.x = 2:47, gbm.y= 1,
#                  family = "poisson", tree.complexity = 5,
#                  learning.rate = 0.001, bag.fraction = 0.5)

brt2_elith_macro <- gbm.step(data = gmpd_panth_macro_train, gbm.x = 2:ncol(gmpd_panth_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.001, bag.fraction = 0.5)

brt3_elith_micro <- gbm.step(data = gmpd_panth_micro_train, gbm.x = 2:ncol(gmpd_panth_train), gbm.y= 1,
                 family = "poisson", tree.complexity = 5,
                 learning.rate = 0.001, bag.fraction = 0.5)

```

```{r}
summary(brt2_elith_macro)
summary(brt3_elith_micro)
```
```{r gmpd pdp 6}
gbm.plot(brt1_elith_full, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "full")
gbm.plot(brt2_elith_macro, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "macro")
gbm.plot(brt3_elith_micro, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = "micro")
```

```{r gmpd pdp 15}
gbm.plot(brt1_elith_full, n.plots=15, plot.layout=c(3, 5), write.title = FALSE)
gbm.plot(brt2_elith_macro, n.plots=15, plot.layout=c(3, 5), write.title = FALSE)
gbm.plot(brt3_elith_micro, n.plots=15, plot.layout=c(3, 5), write.title = FALSE)
```


```{r gmpd pdp2}
brt1_names <- brt1_elith_full$var.names
brt2_names <- brt2_elith_macro$var.names

brt1_long_plot_no <- which(brt1_names %in% c("MaxLongevity_m"))
brt2_long_plot_no <- which(brt2_names %in% c("MaxLongevity_m"))

gbm.plot(brt1_elith_full, variable.no = brt1_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "full")
gbm.plot(brt2_elith_macro, variable.no = brt2_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "macro")
gbm.plot(brt3_elith_micro, variable.no = brt2_long_plot_no, plot.layout=c(1, 1), write.title = FALSE, main = "micro")
```

Becker and Han Method
```{r}
brt1_other_full <- gbm(psr ~ ., data = gmpd_panth_train,
                 distribution = "poisson", n.trees = brt1_elith_full$n.trees,
                 interaction.depth = 5, shrinkage = 0.004)

brt2_other_macro <- gbm(psr ~ ., data = gmpd_panth_macro_train,
                 distribution = "poisson", n.trees = brt2_elith_macro$n.trees,
                 interaction.depth = 5, shrinkage = 0.001)

brt3_other_micro <- gbm(psr ~ ., data = gmpd_panth_micro_train,
                 distribution = "poisson", n.trees = brt3_elith_micro$n.trees,
                 interaction.depth = 5, shrinkage = 0.001)
```

```{r}
summary(brt1_other_full)
summary(brt2_other_macro)
summary(brt3_other_micro)
```





Prediction. Mean Squared Error and Root Mean Square Deviation
```{r}
brt2_macro_test_pred <- predict(brt2_elith_macro, newdata = gmpd_panth_macro_test, n.trees = brt2_elith_macro$n.trees)
mean((brt2_macro_test_pred-gmpd_panth_macro_test$psr)^2)
sqrt(mean((brt2_macro_test_pred-gmpd_panth_macro_test$psr)^2))
```

```{r}
brt2_macro_test_pred_other <- predict(brt2_other_macro, newdata = gmpd_panth_macro_test, n.trees = brt2_other_macro$n.trees)
mean((brt2_macro_test_pred_other-gmpd_panth_macro_test$psr)^2)
sqrt(mean((brt2_macro_test_pred_other-gmpd_panth_macro_test$psr)^2))
```

```{r}
brt3_micro_test_pred <- predict(brt3_elith_micro, newdata = gmpd_panth_micro_test, n.trees = brt3_elith_micro$n.trees)
mean((brt3_micro_test_pred-gmpd_panth_micro_test$psr)^2)
sqrt(mean((brt3_micro_test_pred-gmpd_panth_micro_test$psr)^2))
```

```{r}
brt3_micro_test_pred_other <- predict(brt3_other_micro, newdata = gmpd_panth_micro_test, n.trees = brt3_other_micro$n.trees)
mean((brt3_micro_test_pred_other-gmpd_panth_micro_test$psr)^2)
sqrt(mean((brt3_micro_test_pred_other-gmpd_panth_micro_test$psr)^2))
```
