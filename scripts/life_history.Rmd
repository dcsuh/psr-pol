---
title: "life history"
author: "Daniel Suh"
date: "1/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message = F}
library(tidyverse)
library(magrittr)
library(here)
```

```{r, message =F}
becker_han <- read_csv(here("data/Becker Han 2020 GEB_gpf & BRT data.csv"))
healy_axis <- read_csv(here("data/healy_axis_analysis.csv"))
healy_host <- read_csv(here("data/healy_host_par.csv"))
```

get parasite species richness from healy_host_par.csv
```{r}
healy_psr <- healy_host %>% dplyr::select(host, parasite) %>% group_by(host) %>% summarize(n=n())
```

join with life history data from healy_axis_analysis.csv
first some string manipulation
```{r}
healy_axis %<>% mutate(host = gsub("_", " ", healy_axis$species))
healy_axis_psr <- left_join(healy_axis, healy_psr, by = "host")

#average over duplicates
healy_axis_psr_avg <- healy_axis_psr %>% group_by(species) %>% mutate_each(funs(mean), c(2:15,17,18,20,24)) %>% distinct()

healy_axis_psr_avg$mode_of_life <- factor(healy_axis_psr_avg$mode_of_life)
healy_axis_psr_avg$IUCN <- factor(healy_axis_psr_avg$IUCN)
healy_axis_psr_avg$met_type <- factor(healy_axis_psr_avg$met_type)

healy_axis_psr_avg %<>% dplyr::select(-c(taxa_name,animal,host))
```

mock pca - dont trust this. just checking out workflow
```{r}
healy_pca <- healy_axis_psr_avg %>% dplyr::select(-c(mode_of_life,IUCN,met_type,repo_output,met_rate,n,mass_g,mean_repo_rate)) %>% column_to_rownames(.,var="species")
healy_pca_results <- prcomp(healy_pca)
pc1_scores <- enframe(healy_pca_results$x[,1], name = "species", value = "pc1")
tmp <- healy_axis_psr_avg %>% dplyr::select(species, mean_life_expect, n)
pc1_scores %<>% left_join(.,tmp, by = "species")
pc1_scores %>% ggplot(.,aes(x=pc1,y=log10(n))) + geom_point()
```



## TREES


Let's look at some trees
We can start with just GMPD and Pantheria data

```{r, message =F}
gmpd <- read_csv(here("data/GMPD_main.csv"))
panth1 <- read_tsv(here("data/pantheria/ECOL_90_184/PanTHERIA_1-0_WR05_Aug2008.txt"))
panth2 <- read_tsv(here("data/pantheria/ECOL_90_184/PanTHERIA_1-0_WR93_Aug2008.txt"))
```

Not totally sure what is difference between panth1 and panth2 but panth1 has more entries and has more records for every order when broken down by order so we'll use that for now

Not sure what some of the final variables for panth really mean so we'll just exclude them for now
```{r}
panth1 %<>% dplyr::select(MSW05_Order:`5-7_WeaningBodyMass_g_EXT`)
```


```{r}
gmpd_PSR <- gmpd %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% distinct() %>% 
  group_by(HostCorrectedName) %>% summarize(psr=n())
panth1 %<>% mutate(HostCorrectedName = MSW05_Binomial)
gmpd_panth <- gmpd_PSR %>% inner_join(panth1, by="HostCorrectedName")
```

Let's deal with all the -999 and the references column and the numbers and weird stuff in the column names!!
```{r}
gmpd_panth <- na_if(gmpd_panth, -999.00)
gmpd_panth %<>% dplyr::select(psr, 8, 9, 11, 13, 16, 18:23, 25, 26, 28, 30, 31, 33, 34, 35, 40)
names(gmpd_panth) <- gsub("[[:digit:]]", "", names(gmpd_panth))
names(gmpd_panth) <- gsub("-_", "", names(gmpd_panth))
names(gmpd_panth) <- gsub("_", "", names(gmpd_panth))
names(gmpd_panth) <- gsub(" ", "", names(gmpd_panth))
names(gmpd_panth) <- gsub("/", "", names(gmpd_panth))
```


quick linear regression example

```{r}
ggplot(gmpd_panth, aes(x=psr)) + geom_histogram(binwidth = 1)

library(reshape2)
gmpd_panth2 <- gmpd_panth %>% melt(., id.vars = "psr")
gmpd_panth2 %>% ggplot(.,aes(x=value,y=psr)) + geom_point() + geom_smooth(method="lm") + facet_wrap(~variable, scales = "free_x")
```


Multiple linear regression surely won't work but why not GAMs??



```{r}
library(tree)
set.seed(07981)
train <- sample(1:nrow(gmpd_panth), nrow(gmpd_panth) / 2)
tree_gmpd <- tree(psr~., gmpd_panth, subset = train)
summary(tree_gmpd)
```

cross-validation
```{r}
cv_gmpd <- cv.tree(tree_gmpd)
plot (cv_gmpd$size , cv_gmpd$dev, type = "b")
```

prune
```{r}
prune_gmpd <- prune.tree(tree_gmpd, best = 3)
plot(prune_gmpd)
text(prune_gmpd)
```


```{r}
yhat <- predict(tree_gmpd, newdata = gmpd_panth[-train , ])
gmpd_test <- gmpd_panth[-train , "psr"]
plot(yhat, gmpd_test$psr)
abline(0, 1)
mean((yhat - gmpd_test$psr)^2)
```






test gbm
```{r}
library(gbm)
boost_gmpd <- gbm(psr~., data = gmpd_panth[train, ],
  distribution = "poisson", n.trees = 5000,
  interaction.depth = 4)
```


```{r}
summary(boost_gmpd)
plot.gbm(boost_gmpd, i.var=2)
plot.gbm(boost_gmpd, i.var=11)
plot.gbm(boost_gmpd, i.var=12)
plot.gbm(boost_gmpd, i.var=16)
```

```{r}
yhat_boost <- predict(boost_gmpd, newdata = gmpd_panth[-train, ], n.trees = 5000)
mean((yhat_boost-boost_gmpd$data$y)^2)
sqrt(mean((yhat_boost-boost_gmpd$data$y)^2))
```

things to do:

 - turn references column into reference count
 - go through each variable and choose just the most important ones
 - subset analysis by host or parasite type
 
```{r}
gmpd_VSR <- gmpd %>% filter(ParType == "Virus") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% distinct() %>% 
  group_by(HostCorrectedName) %>% summarize(vsr=n())
gmpd_panth_v <- gmpd_VSR %>% inner_join(panth1, by="HostCorrectedName")
```

Let's deal with all the -999 and the references column and the numbers and weird stuff in the column names!!
```{r}
gmpd_panth_v <- na_if(gmpd_panth_v, -999.00)
gmpd_panth_v %<>% dplyr::select(vsr, 8, 9, 11, 13, 16, 18:23, 25, 26, 28, 30, 31, 33, 34, 35, 40)
names(gmpd_panth_v) <- gsub("[[:digit:]]", "", names(gmpd_panth_v))
names(gmpd_panth_v) <- gsub("-_", "", names(gmpd_panth_v))
names(gmpd_panth_v) <- gsub("_", "", names(gmpd_panth_v))
names(gmpd_panth_v) <- gsub(" ", "", names(gmpd_panth_v))
names(gmpd_panth_v) <- gsub("/", "", names(gmpd_panth_v))
```


```{r}
train <- sample(1:nrow(gmpd_panth_v), nrow(gmpd_panth_v) / 2)

boost_gmpd_v <- gbm(vsr~., data = gmpd_panth_v[train, ],
  distribution = "poisson", n.trees = 5000,
  interaction.depth = 4)
```


```{r}
summary(boost_gmpd_v)
plot.gbm(boost_gmpd_v, i.var=2)
plot.gbm(boost_gmpd_v, i.var=11)
plot.gbm(boost_gmpd_v, i.var=12)
plot.gbm(boost_gmpd_v, i.var=16)
```

```{r}
yhat_boost_v <- predict(boost_gmpd_v, newdata = gmpd_panth_v[-train, ], n.trees = 5000)
mean((yhat_boost_v-boost_gmpd_v$data$y)^2)
sqrt(mean((yhat_boost_v-boost_gmpd_v$data$y)^2))
```
 
Now again with helminths!
 
```{r}
gmpd_HSR <- gmpd %>% filter(ParType == "Helminth") %>% dplyr::select(HostCorrectedName,ParasiteCorrectedName) %>% distinct() %>% 
  group_by(HostCorrectedName) %>% summarize(hsr=n())
gmpd_panth_h <- gmpd_HSR %>% inner_join(panth1, by="HostCorrectedName")
```

Let's deal with all the -999 and the references column and the numbers and weird stuff in the column names!!
```{r}
gmpd_panth_h <- na_if(gmpd_panth_h, -999.00)
gmpd_panth_h %<>% dplyr::select(hsr, 8, 9, 11, 13, 16, 18:23, 25, 26, 28, 30, 31, 33, 34, 35, 40)
names(gmpd_panth_h) <- gsub("[[:digit:]]", "", names(gmpd_panth_h))
names(gmpd_panth_h) <- gsub("-_", "", names(gmpd_panth_h))
names(gmpd_panth_h) <- gsub("_", "", names(gmpd_panth_h))
names(gmpd_panth_h) <- gsub(" ", "", names(gmpd_panth_h))
names(gmpd_panth_h) <- gsub("/", "", names(gmpd_panth_h))
```
 
```{r}
train <- sample(1:nrow(gmpd_panth_h), nrow(gmpd_panth_h) / 2)
boost_gmpd_h <- gbm(hsr~., data = gmpd_panth_h[train, ],
  distribution = "poisson", n.trees = 5000,
  interaction.depth = 4)
```


```{r}
summary(boost_gmpd_h)
plot.gbm(boost_gmpd_h, i.var=2)
plot.gbm(boost_gmpd_h, i.var=11)
plot.gbm(boost_gmpd_h, i.var=12)
plot.gbm(boost_gmpd_h, i.var=16)
```

```{r}
yhat_boost_h <- predict(boost_gmpd_h, newdata = gmpd_panth_h[-train, ], n.trees = 5000)
mean((yhat_boost_h-boost_gmpd_h$data$y)^2)
sqrt(mean((yhat_boost_h-boost_gmpd_h$data$y)^2))
```
 
 
```{r}
plot.gbm(boost_gmpd, i.var=2)
plot.gbm(boost_gmpd_v, i.var=2)
plot.gbm(boost_gmpd_h, i.var=2)
```

```{r}
plot.gbm(boost_gmpd, i.var=11)
plot.gbm(boost_gmpd_v, i.var=11)
plot.gbm(boost_gmpd_h, i.var=11)
```

```{r}
plot.gbm(boost_gmpd, i.var=12)
plot.gbm(boost_gmpd_v, i.var=12)
plot.gbm(boost_gmpd_h, i.var=12)
```

```{r}
library(pdp)

library(cowplot)

```

```{r}
inv <- pdp::partial(boost_gmpd, n.trees=5000, "MaxLongevitym")

plot1 <- inv %>%
  #dplyr::select(coral.area, yhat) %>%
  na.omit() %>%
  ggplot() +
  geom_line(aes(x = MaxLongevitym, y = yhat),color="magenta4",size=1) +
  xlim(0,750)+
  ylab(" ") +
  theme_minimal() +
  theme(axis.title.x = element_blank())+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text=element_text(size=12))

plot2 <- gmpd_panth %>%
  dplyr::select(MaxLongevitym) %>%
  na.omit() %>%
  ggplot(aes(MaxLongevitym)) +
  geom_histogram(breaks=seq(0,750, by = 10),fill="thistle2") +
  #geom_histogram(fill="gray",binwidth=20) +
  scale_y_continuous(position = "right")+
  ylab("") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),axis.text=element_text(size=12))#+
#theme(plot.margin=unit(c(0,0,0,1.25),"cm"))


p1 <- add_sub(plot1," ")
p2 <- add_sub(plot2,"MaxLongevity",size=12)
p.maxLong<-ggdraw() +
  draw_plot(p2,x=0.05,scale=0.95) +
  draw_plot(p1,x=-0.04,scale=0.975,y=0.05)
p.maxLong
```

```{r}
inv <- pdp::partial(boost_gmpd_v, n.trees=5000, "MaxLongevitym")

plot1 <- inv %>%
  #dplyr::select(coral.area, yhat) %>%
  na.omit() %>%
  ggplot() +
  geom_line(aes(x = MaxLongevitym, y = yhat),color="magenta4",size=1) +
  xlim(0,750)+
  ylab(" ") +
  theme_minimal() +
  theme(axis.title.x = element_blank())+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text=element_text(size=12))

plot2 <- gmpd_panth_v %>%
  dplyr::select(MaxLongevitym) %>%
  na.omit() %>%
  ggplot(aes(MaxLongevitym)) +
  geom_histogram(breaks=seq(0,750, by = 10),fill="thistle2") +
  #geom_histogram(fill="gray",binwidth=20) +
  scale_y_continuous(position = "right")+
  ylab("") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),axis.text=element_text(size=12))#+
#theme(plot.margin=unit(c(0,0,0,1.25),"cm"))


p1 <- add_sub(plot1," ")
p2 <- add_sub(plot2,"MaxLongevity",size=12)
p.maxLong<-ggdraw() +
  draw_plot(p2,x=0.05,scale=0.95) +
  draw_plot(p1,x=-0.04,scale=0.975,y=0.05)
p.maxLong
```

```{r}
inv <- pdp::partial(boost_gmpd_h, n.trees=5000, "MaxLongevitym")

plot1 <- inv %>%
  #dplyr::select(coral.area, yhat) %>%
  na.omit() %>%
  ggplot() +
  geom_line(aes(x = MaxLongevitym, y = yhat),color="magenta4",size=1) +
  xlim(0,750)+
  ylab(" ") +
  theme_minimal() +
  theme(axis.title.x = element_blank())+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text=element_text(size=12))

plot2 <- gmpd_panth_h %>%
  dplyr::select(MaxLongevitym) %>%
  na.omit() %>%
  ggplot(aes(MaxLongevitym)) +
  geom_histogram(breaks=seq(0,750, by = 10),fill="thistle2") +
  #geom_histogram(fill="gray",binwidth=20) +
  scale_y_continuous(position = "right")+
  ylab("") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),axis.text=element_text(size=12))#+
#theme(plot.margin=unit(c(0,0,0,1.25),"cm"))


p1 <- add_sub(plot1," ")
p2 <- add_sub(plot2,"MaxLongevity",size=12)
p.maxLong<-ggdraw() +
  draw_plot(p2,x=0.05,scale=0.95) +
  draw_plot(p1,x=-0.04,scale=0.975,y=0.05)
p.maxLong
```



```{r}
plot.gbm(boost_gmpd, i.var=16)
plot.gbm(boost_gmpd_v, i.var=16)
plot.gbm(boost_gmpd_h, i.var=16)
```
 
 
 - see if Healy dataset makes more sense
 - do this with healy data instead for life history data

```{r}
ggplot(healy_axis_psr, aes(x=n)) + geom_histogram(binwidth = 5)

healy_psr_2 <- healy_axis_psr %>% melt(., id.vars = "n")
healy_psr_2 %>% ggplot(.,aes(x=value,y=n)) + geom_point() + geom_smooth(method="lm") + facet_wrap(~variable, scales = "free_x")
```



```{r}
healy_axis_psr %<>% dplyr::select(-c(animal, host, species, taxa_name)) 
healy_axis_psr$mode_of_life <- as.factor(healy_axis_psr$mode_of_life)
healy_axis_psr$IUCN <- as.factor(healy_axis_psr$IUCN)
healy_axis_psr$met_type <- as.factor(healy_axis_psr$met_type)
healy_axis_psr %<>% filter(!is.na(n))
train <- sample(1:nrow(healy_axis_psr), nrow(healy_axis_psr) / 2)
boost_healy <- gbm(n~., data = healy_axis_psr[train, ],
  distribution = "poisson", n.trees = 5000,
  interaction.depth = 4)
summary(boost_healy)
```

```{r}
yhat_boost_healy <- predict(boost_healy, newdata = healy_axis_psr[-train, ], n.trees = 5000)
mean((yhat_boost_healy-boost_healy$data$y)^2)
sqrt(mean((yhat_boost_healy-boost_healy$data$y)^2))
```



# Additional thoughts

Should I try to find the hosts that have both helminths and viruses and then only use those for an analysis? So that the host dataset is at least the same. i.e. If we have the same hosts, and we assume we are comprehensive with both helminth and virus richness, then we can maybe be more confident that any patterns we see are real and not driven by parasite-induced sampling biases of hosts?

